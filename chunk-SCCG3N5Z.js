import{a as E,b as P}from"./chunk-H4HRTHOW.js";import{a as $,b as m}from"./chunk-6MDQTQU3.js";var T=/_key\s*==\s*['"](.*)['"]/;function W(t){return typeof t=="string"?T.test(t.trim()):typeof t=="object"&&"_key"in t}function U(t){if(!Array.isArray(t))throw new Error("Path is not an array");return t.reduce((e,r,n)=>{let i=typeof r;if(i==="number")return`${e}[${r}]`;if(i==="string")return`${e}${n===0?"":"."}${r}`;if(W(r)&&r._key)return`${e}[_key=="${r._key}"]`;if(Array.isArray(r)){let[c,o]=r;return`${e}[${c}:${o}]`}throw new Error(`Unsupported path segment \`${JSON.stringify(r)}\``)},"")}var S={"\f":"\\f","\n":"\\n","\r":"\\r","	":"\\t","'":"\\'","\\":"\\\\"},R={"\\f":"\f","\\n":`
`,"\\r":"\r","\\t":"	","\\'":"'","\\\\":"\\"};function V(t){return`$${t.map(e=>typeof e=="string"?`['${e.replace(/[\f\n\r\t'\\]/g,r=>S[r])}']`:typeof e=="number"?`[${e}]`:e._key!==""?`[?(@._key=='${e._key.replace(/['\\]/g,r=>S[r])}')]`:`[${e._index}]`).join("")}`}function I(t){let e=[],r=/\['(.*?)'\]|\[(\d+)\]|\[\?\(@\._key=='(.*?)'\)\]/g,n;for(;(n=r.exec(t))!==null;){if(n[1]!==void 0){let i=n[1].replace(/\\(\\|f|n|r|t|')/g,c=>R[c]);e.push(i);continue}if(n[2]!==void 0){e.push(parseInt(n[2],10));continue}if(n[3]!==void 0){let i=n[3].replace(/\\(\\')/g,c=>R[c]);e.push({_key:i,_index:-1});continue}}return e}function O(t){return t.map(e=>{if(typeof e=="string"||typeof e=="number")return e;if(e._key!=="")return{_key:e._key};if(e._index!==-1)return e._index;throw new Error(`invalid segment:${JSON.stringify(e)}`)})}function M(t){return t.map(e=>{if(typeof e=="string"||typeof e=="number")return e;if(e._index!==-1)return e._index;throw new Error(`invalid segment:${JSON.stringify(e)}`)})}function q(t,e){if(!e?.mappings)return;let r=V(M(t));if(e.mappings[r]!==void 0)return{mapping:e.mappings[r],matchedPath:r,pathSuffix:""};let n=Object.entries(e.mappings).filter(([f])=>r.startsWith(f)).sort(([f],[s])=>s.length-f.length);if(n.length==0)return;let[i,c]=n[0],o=r.substring(i.length);return{mapping:c,matchedPath:i,pathSuffix:o}}function J(t){return t!==null&&Array.isArray(t)}function l(t,e,r=[]){if(J(t))return t.map((n,i)=>{if(E(n)){let c=n._key;if(typeof c=="string")return l(n,e,r.concat({_key:c,_index:i}))}return l(n,e,r.concat(i))});if(E(t)){if(t._type==="block"||t._type==="span"){let n=$({},t);return t._type==="block"?n.children=l(t.children,e,r.concat("children")):t._type==="span"&&(n.text=l(t.text,e,r.concat("text"))),n}return Object.fromEntries(Object.entries(t).map(([n,i])=>[n,l(i,e,r.concat(n))]))}return e(t,r)}function F(t,e,r){return l(t,(n,i)=>{if(typeof n!="string")return n;let c=q(i,e);if(!c)return n;let{mapping:o,matchedPath:f}=c;if(o.type!=="value"||o.source.type!=="documentValue")return n;let s=e.documents[o.source.document],p=e.paths[o.source.path],d=I(f),a=I(p).concat(i.slice(d.length));return r({sourcePath:a,sourceDocument:s,resultPath:i,value:n})})}var G="drafts",H="versions",g=".",D=`${G}${g}`,K=`${H}${g}`;function L(t){return t.startsWith(D)}function w(t){return t.startsWith(K)}function X(t){return!L(t)&&!w(t)}function z(t){if(!w(t))return;let[e,r,...n]=t.split(g);return r}function B(t){return w(t)?t.split(g).slice(2).join(g):L(t)?t.slice(D.length):t}function Q(t){let{baseUrl:e,workspace:r="default",tool:n="default",id:i,type:c,path:o,projectId:f,dataset:s}=t;if(!e)throw new Error("baseUrl is required");if(!o)throw new Error("path is required");if(!i)throw new Error("id is required");if(e!=="/"&&e.endsWith("/"))throw new Error("baseUrl must not end with a slash");let p=r==="default"?void 0:r,d=n==="default"?void 0:n,a=B(i),h=Array.isArray(o)?U(O(o)):o,u=new URLSearchParams({baseUrl:e,id:a,type:c,path:h});if(p&&u.set("workspace",p),d&&u.set("tool",d),f&&u.set("projectId",f),s&&u.set("dataset",s),X(i))u.set("perspective","published");else if(w(i)){let b=z(i);u.set("perspective",b)}let y=[e==="/"?"":e];p&&y.push(p);let _=["mode=presentation",`id=${a}`,`type=${c}`,`path=${encodeURIComponent(h)}`];return d&&_.push(`tool=${d}`),y.push("intent","edit",`${_.join(";")}?${u}`),y.join("/")}function Y(t){let e=typeof t=="string"?t:t.baseUrl;return e!=="/"&&(e=e.replace(/\/$/,"")),typeof t=="string"?{baseUrl:e}:m($({},t),{baseUrl:e})}var A=({sourcePath:t,resultPath:e,value:r})=>{if(v(r)||tt(r))return!1;let n=t.at(-1);return!(t.at(-2)==="slug"&&n==="current"||typeof n=="string"&&(n.startsWith("_")||n.endsWith("Id"))||t.some(i=>i==="meta"||i==="metadata"||i==="openGraph"||i==="seo")||x(t)||x(e)||typeof n=="string"&&Z.has(n))},Z=new Set(["color","colour","currency","email","format","gid","hex","href","hsl","hsla","icon","id","index","key","language","layout","link","linkAction","locale","lqip","page","path","ref","rgb","rgba","route","secret","slug","status","tag","template","theme","type","textTheme","unit","url","username","variant","website"]);function v(t){return/^\d{4}-\d{2}-\d{2}/.test(t)?!!Date.parse(t):!1}function tt(t){try{new URL(t,t.startsWith("/")?"https://acme.com":void 0)}catch{return!1}return!0}function x(t){return t.some(e=>typeof e=="string"&&e.match(/type/i)!==null)}var k=20;function et(t,e,r){let{filter:n,logger:i,enabled:c}=r;if(!c){let s="config.enabled must be true, don't call this function otherwise";throw i?.error?.(`[@sanity/client]: ${s}`,{result:t,resultSourceMap:e,config:r}),new TypeError(s)}if(!e)return i?.error?.("[@sanity/client]: Missing Content Source Map from response body",{result:t,resultSourceMap:e,config:r}),t;if(!r.studioUrl){let s="config.studioUrl must be defined";throw i?.error?.(`[@sanity/client]: ${s}`,{result:t,resultSourceMap:e,config:r}),new TypeError(s)}let o={encoded:[],skipped:[]},f=F(t,e,({sourcePath:s,sourceDocument:p,resultPath:d,value:a})=>{if((typeof n=="function"?n({sourcePath:s,resultPath:d,filterDefault:A,sourceDocument:p,value:a}):A({sourcePath:s,resultPath:d,value:a}))===!1)return i&&o.skipped.push({path:j(s),value:`${a.slice(0,k)}${a.length>k?"...":""}`,length:a.length}),a;i&&o.encoded.push({path:j(s),value:`${a.slice(0,k)}${a.length>k?"...":""}`,length:a.length});let{baseUrl:h,workspace:u,tool:y}=Y(typeof r.studioUrl=="function"?r.studioUrl(p):r.studioUrl);if(!h)return a;let{_id:_,_type:b,_projectId:C,_dataset:N}=p;return P(a,{origin:"sanity.io",href:Q($({baseUrl:h,workspace:u,tool:y,id:_,type:b,path:s},!r.omitCrossDatasetReferenceData&&{dataset:N,projectId:C}))},!1)});if(i){let s=o.skipped.length,p=o.encoded.length;if((s||p)&&((i?.groupCollapsed||i.log)?.("[@sanity/client]: Encoding source map into result"),i.log?.(`[@sanity/client]: Paths encoded: ${o.encoded.length}, skipped: ${o.skipped.length}`)),o.encoded.length>0&&(i?.log?.("[@sanity/client]: Table of encoded paths"),(i?.table||i.log)?.(o.encoded)),o.skipped.length>0){let d=new Set;for(let{path:a}of o.skipped)d.add(a.replace(T,"0").replace(/\[\d+\]/g,"[]"));i?.log?.("[@sanity/client]: List of skipped paths",[...d.values()])}(s||p)&&i?.groupEnd?.()}return f}function j(t){return U(O(t))}var nt=Object.freeze({__proto__:null,stegaEncodeSourceMap:et});export{F as encodeIntoResult,et as stegaEncodeSourceMap,nt as stegaEncodeSourceMap$1};
